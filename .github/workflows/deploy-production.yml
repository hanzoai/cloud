name: Deploy Production

on:
  push:
    branches:
      - main
    paths:
      - "**/*.go"
      - "conf/**"
      - "k8s/**"
      - "Dockerfile"
      - ".github/workflows/deploy-production.yml"
  workflow_dispatch:

concurrency:
  group: cloud-production
  cancel-in-progress: false

env:
  REGISTRY: ghcr.io/hanzoai
  IMAGE_NAME: cloud
  NAMESPACE: hanzo
  DEPLOYMENT_NAME: cloud-api
  CONTAINER_NAME: cloud-api
  IAM_INTERNAL_ENDPOINT: http://iam.hanzo.svc.cluster.local:8000

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    outputs:
      image: ${{ steps.meta.outputs.image }}
    steps:
      - uses: actions/checkout@v4

      - name: Enforce IAM-only auth and billing integration
        run: |
          set -euo pipefail
          grep -q 'iamEndpoint' controllers/openai_api.go
          ! grep -q 'casdoorEndpoint' controllers/openai_api.go
          grep -q 'recordUsage' controllers/openai_api.go

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push cloud image
        uses: docker/build-push-action@v5
        with:
          context: .
          target: STANDARD
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            ghcr.io/hanzoai/cloud:${{ github.sha }}
            ghcr.io/hanzoai/cloud:latest

      - name: Set image output
        id: meta
        run: echo "image=${REGISTRY}/${IMAGE_NAME}:${GITHUB_SHA}" >> "$GITHUB_OUTPUT"

  deploy:
    runs-on: ubuntu-latest
    needs: build-and-push
    steps:
      - name: Install doctl
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DO_API_TOKEN }}

      - name: Configure kubectl
        run: |
          set -euo pipefail
          doctl kubernetes cluster kubeconfig save "${{ secrets.DO_CLUSTER_ID }}"

      - name: Roll out cloud-api
        run: |
          set -euo pipefail
          kubectl set image deployment/"$DEPLOYMENT_NAME" \
            "$CONTAINER_NAME"="${{ needs.build-and-push.outputs.image }}" \
            -n "$NAMESPACE"
          kubectl rollout status deployment/"$DEPLOYMENT_NAME" -n "$NAMESPACE" --timeout=600s

      - name: Verify IAM tenancy configuration
        run: |
          set -euo pipefail
          kubectl get secret cloud-runtime-secrets -n "$NAMESPACE" >/dev/null
          IAM_ENDPOINT="$(kubectl get secret cloud-runtime-secrets -n "$NAMESPACE" -o jsonpath='{.data.iamEndpoint}' | base64 -d)"
          CLIENT_ID="$(kubectl get secret cloud-runtime-secrets -n "$NAMESPACE" -o jsonpath='{.data.clientId}' | base64 -d)"
          CLIENT_SECRET="$(kubectl get secret cloud-runtime-secrets -n "$NAMESPACE" -o jsonpath='{.data.clientSecret}' | base64 -d)"
          DATA_SOURCE_NAME="$(kubectl get secret cloud-runtime-secrets -n "$NAMESPACE" -o jsonpath='{.data.dataSourceName}' | base64 -d)"
          HANZO_API_KEY_VALUE="$(kubectl get secret cloud-runtime-secrets -n "$NAMESPACE" -o jsonpath='{.data.HANZO_API_KEY}' | base64 -d)"
          if [ "$IAM_ENDPOINT" != "$IAM_INTERNAL_ENDPOINT" ]; then
            echo "cloud-runtime-secrets.iamEndpoint must be ${IAM_INTERNAL_ENDPOINT}, got ${IAM_ENDPOINT}"
            exit 1
          fi
          [ -n "$CLIENT_ID" ] || (echo "cloud-runtime-secrets.clientId is empty" && exit 1)
          [ -n "$CLIENT_SECRET" ] || (echo "cloud-runtime-secrets.clientSecret is empty" && exit 1)
          [ -n "$DATA_SOURCE_NAME" ] || (echo "cloud-runtime-secrets.dataSourceName is empty" && exit 1)
          [ -n "$HANZO_API_KEY_VALUE" ] || (echo "cloud-runtime-secrets.HANZO_API_KEY is empty" && exit 1)

      - name: Verify public health endpoint
        run: |
          set -euo pipefail
          STATUS="$(curl -sS -o /dev/null -w "%{http_code}" https://cloud.hanzo.ai/api/health || true)"
          if [ "$STATUS" != "200" ]; then
            echo "health check failed: https://cloud.hanzo.ai/api/health returned $STATUS"
            exit 1
          fi

      - name: Rollback on failure
        if: failure()
        run: |
          set -euo pipefail
          kubectl rollout undo deployment/"$DEPLOYMENT_NAME" -n "$NAMESPACE"
          kubectl rollout status deployment/"$DEPLOYMENT_NAME" -n "$NAMESPACE" --timeout=300s
