name: Deploy Production

on:
  push:
    branches:
      - master
    paths:
      - "**/*.go"
      - "conf/**"
      - "k8s/**"
      - "Dockerfile"
      - ".github/workflows/deploy-production.yml"
  workflow_dispatch:

concurrency:
  group: cloud-production
  cancel-in-progress: false

env:
  REGISTRY: ghcr.io/hanzoai
  IMAGE_NAME: cloud
  NAMESPACE: hanzo
  DEPLOYMENT_NAME: cloud-api
  CONTAINER_NAME: cloud-api
  IAM_INTERNAL_ENDPOINT: http://iam.hanzo.svc.cluster.local:8000
  KMS_ENDPOINT: https://kms.hanzo.ai
  KMS_PROJECT_ID: 2104f3b4-9276-476c-9727-550313285bd8
  KMS_ENVIRONMENT: prod
  KMS_DO_API_TOKEN_KEY: do-api-token
  KMS_DO_CLUSTER_ID_KEY: do-cluster-id

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    outputs:
      image: ${{ steps.meta.outputs.image }}
    steps:
      - uses: actions/checkout@v4

      - name: Enforce IAM-only auth and billing integration
        run: |
          set -euo pipefail
          grep -q 'iamEndpoint' controllers/openai_api.go
          ! grep -q 'casdoorEndpoint' controllers/openai_api.go
          grep -q 'recordUsage' controllers/openai_api.go

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push cloud image
        uses: docker/build-push-action@v5
        with:
          context: .
          target: STANDARD
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            ghcr.io/hanzoai/cloud:${{ github.sha }}
            ghcr.io/hanzoai/cloud:latest

      - name: Set image output
        id: meta
        run: echo "image=${REGISTRY}/${IMAGE_NAME}:${GITHUB_SHA}" >> "$GITHUB_OUTPUT"

  deploy:
    runs-on: ubuntu-latest
    needs: build-and-push
    steps:
      - name: Resolve deploy secrets from Hanzo KMS
        id: kms
        env:
          HANZO_API_KEY: ${{ secrets.HANZO_API_KEY }}
          KMS_CLIENT_ID: ${{ secrets.KMS_CLIENT_ID }}
          KMS_CLIENT_SECRET: ${{ secrets.KMS_CLIENT_SECRET }}
          KMS_PROJECT_ID: ${{ secrets.KMS_PROJECT_ID || vars.KMS_PROJECT_ID || env.KMS_PROJECT_ID }}
        run: |
          set -euo pipefail

          if [ -z "${KMS_PROJECT_ID:-}" ]; then
            echo "KMS project is required: set KMS_PROJECT_ID (secret or repo variable)"
            exit 1
          fi

          if [ -n "${HANZO_API_KEY:-}" ]; then
            ACCESS_TOKEN="${HANZO_API_KEY}"
          else
            if [ -z "${KMS_CLIENT_ID:-}" ] || [ -z "${KMS_CLIENT_SECRET:-}" ]; then
              echo "Set HANZO_API_KEY, or set both KMS_CLIENT_ID and KMS_CLIENT_SECRET"
              exit 1
            fi

            AUTH_PAYLOAD="$(printf '{"clientId":"%s","clientSecret":"%s"}' "$KMS_CLIENT_ID" "$KMS_CLIENT_SECRET")"
            ACCESS_TOKEN="$(curl -fsS \
              -H "Content-Type: application/json" \
              -d "$AUTH_PAYLOAD" \
              "${KMS_ENDPOINT}/api/v1/auth/universal-auth/login" | \
              python3 -c 'import sys, json; print(json.load(sys.stdin)["accessToken"])')"
          fi

          fetch_kms_secret() {
            local secret_name="$1"
            curl -fsS \
              -H "Authorization: Bearer ${ACCESS_TOKEN}" \
              "${KMS_ENDPOINT}/api/v4/secrets/${secret_name}?projectId=${KMS_PROJECT_ID}&environment=${KMS_ENVIRONMENT}" | \
              python3 -c 'import sys, json; print(json.load(sys.stdin)["secret"]["secretValue"])'
          }

          DO_API_TOKEN="$(fetch_kms_secret "${KMS_DO_API_TOKEN_KEY}")"
          DO_CLUSTER_ID="$(fetch_kms_secret "${KMS_DO_CLUSTER_ID_KEY}")"

          echo "::add-mask::${ACCESS_TOKEN}"
          echo "::add-mask::${DO_API_TOKEN}"
          echo "::add-mask::${DO_CLUSTER_ID}"
          echo "do_api_token=${DO_API_TOKEN}" >> "$GITHUB_OUTPUT"
          echo "do_cluster_id=${DO_CLUSTER_ID}" >> "$GITHUB_OUTPUT"

      - name: Install doctl
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{ steps.kms.outputs.do_api_token }}

      - name: Configure kubectl
        run: |
          set -euo pipefail
          CLUSTER="${{ steps.kms.outputs.do_cluster_id }}"
          if [ -z "$CLUSTER" ]; then
            echo "Missing do-cluster-id secret in KMS"
            exit 1
          fi
          doctl kubernetes cluster kubeconfig save "$CLUSTER"

      - name: Roll out cloud-api
        run: |
          set -euo pipefail
          kubectl set image deployment/"$DEPLOYMENT_NAME" \
            "$CONTAINER_NAME"="${{ needs.build-and-push.outputs.image }}" \
            -n "$NAMESPACE"
          kubectl rollout status deployment/"$DEPLOYMENT_NAME" -n "$NAMESPACE" --timeout=600s

      - name: Verify IAM tenancy configuration
        run: |
          set -euo pipefail
          kubectl get secret cloud-runtime-secrets -n "$NAMESPACE" >/dev/null
          IAM_ENDPOINT="$(kubectl get secret cloud-runtime-secrets -n "$NAMESPACE" -o jsonpath='{.data.iamEndpoint}' | base64 -d)"
          CLIENT_ID="$(kubectl get secret cloud-runtime-secrets -n "$NAMESPACE" -o jsonpath='{.data.clientId}' | base64 -d)"
          CLIENT_SECRET="$(kubectl get secret cloud-runtime-secrets -n "$NAMESPACE" -o jsonpath='{.data.clientSecret}' | base64 -d)"
          DATA_SOURCE_NAME="$(kubectl get secret cloud-runtime-secrets -n "$NAMESPACE" -o jsonpath='{.data.dataSourceName}' | base64 -d)"
          HANZO_API_KEY_VALUE="$(kubectl get secret cloud-runtime-secrets -n "$NAMESPACE" -o jsonpath='{.data.HANZO_API_KEY}' | base64 -d)"
          if [ "$IAM_ENDPOINT" != "$IAM_INTERNAL_ENDPOINT" ]; then
            echo "cloud-runtime-secrets.iamEndpoint must be ${IAM_INTERNAL_ENDPOINT}, got ${IAM_ENDPOINT}"
            exit 1
          fi
          [ -n "$CLIENT_ID" ] || (echo "cloud-runtime-secrets.clientId is empty" && exit 1)
          [ -n "$CLIENT_SECRET" ] || (echo "cloud-runtime-secrets.clientSecret is empty" && exit 1)
          [ -n "$DATA_SOURCE_NAME" ] || (echo "cloud-runtime-secrets.dataSourceName is empty" && exit 1)
          [ -n "$HANZO_API_KEY_VALUE" ] || (echo "cloud-runtime-secrets.HANZO_API_KEY is empty" && exit 1)

      - name: Verify public health endpoint
        run: |
          set -euo pipefail
          STATUS="$(curl -sS -o /dev/null -w "%{http_code}" https://cloud.hanzo.ai/api/health || true)"
          if [ "$STATUS" != "200" ]; then
            echo "health check failed: https://cloud.hanzo.ai/api/health returned $STATUS"
            exit 1
          fi

      - name: Rollback on failure
        if: failure()
        run: |
          set -euo pipefail
          kubectl rollout undo deployment/"$DEPLOYMENT_NAME" -n "$NAMESPACE"
          kubectl rollout status deployment/"$DEPLOYMENT_NAME" -n "$NAMESPACE" --timeout=300s
